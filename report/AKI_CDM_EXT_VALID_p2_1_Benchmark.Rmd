---
title: "Building and Validating Predictive Models for Acute Kidney Injury (AKI) using PCORnet CDM (Part II.1)"
author: "xing song"
date: "Feburary 09, 2019"
output: html_document
params:
  preprocess: TRUE
---

### Data Preparation    

If `preprocess==TRUE`, it will first run `data_preproc.R` to preprocess and transform raw data into to a discrete-survival-like representation, which will used for model validation as well as refitting. At this preparation stage, the raw data tables will be cleaned and transformed to a discrete-survival-like representation, which will be used for stage 2.1 and stage 2.2. To reduce the burden on memory requirements, the ETL (extract, transform, load) process will be performed in chunks with respect to **distinct prediction task, encounter years and variable types**. Meanwhile, indices for random partitioning will be assigned to each encounter.

```{bash preprocess, engine.opts='-l',include=F,eval=params$preprocess}
Rscript -e data_preproc.R
```


### Stage 2.1: Validating Transported Model (Benchmark)   

In this experiment, we will validate the benchmark predictive model by quasi-replicating the model by [*Koyner et al*] for AKI risk prediction on the adult inpatients, which was trained on KUMC's data using PCORnet common data model. This learning frame work by Koyner et al is, by far, the best reported general inpatients AKI prediction model, which is based on a tuned gradient boosting machine in a discrete time survival analysis framework with pre-selected EHR data elements. We aim to extend this benchmark prediction model by including novel elements from PCORnet CDM, while effectively automate the manual efforts of feature pre-selection and cleaning. The primary outcomes of this study were the development of AKI stage ≥ 1, AKI stage ≥ 2, and AKI stage 3 in the next 24 and 48 hours. KUMC's model and some auxillary data will be delivered via securefile. 

[*Koyner et al*] https://www.ncbi.nlm.nih.gov/pubmed/29596073 

***

```{r setup, include=F}
rm(list=ls())
gc()

#source utility functions
source("./R/util.R")

require_libraries(c("tidyr",
                    "dplyr",
                    "magrittr",
                    "stringr",
                    "broom",
                    "Matrix",
                    "xgboost",
                    "ROCR",
                    "PRROC",
                    "ResourceSelection",
                    "knitr",
                    "kableExtra",
                    "ggplot2",
                    "ggrepel",
                    "gridExtra",
                    "ggpubr",
                    "openxlsx"))

# experimental design parameters
#----prediction ending point
pred_end<-7 #only collect data within 7 days since admission

#-----prediction point
pred_in_d_opt<-c(1,2)

#-----prediction tasks
pred_task_lst<-c("stg1up","stg2up","stg3")

#-----feature selection type
fs_type_opt<-c("no_fs","rm_scr_bun")
rm_key<-c('2160-0','38483-4','14682-9','21232-4','35203-9','44784-7','59826-8',
          '16188-5','16189-3','59826-8','35591-7','50380-5','50381-3','35592-5',
          '44784-7','11041-1','51620-3','72271-0','11042-9','51619-5','35203-9','14682-9',
          '12966-8','12965-0','6299-2','59570-2','12964-3','49071-4','72270-2',
          '11065-0','3094-0','35234-4','14937-7',
          '48642-3','48643-1', #eGFR
          '3097-3','44734-2','BUN_SCR')
```


After receiving the `model_kumc.zip` from KUMC via securefile, unzip the data and save under `.../data/model_kumc`. The model will be validated on the overall cohort from the site by generating a AKI risk score for different AKI stages. The validation progress will be reported as follows:

```{r benchmark, echo=F, eval=F}
boots<-30

for(pred_in_d in pred_in_d_opt){
    #initialize empty vectors for saving results (1d-,2d-, prediction)
    perf_full_bs<-c()
    perf_overall_bs<-c()
    perf_calib_bs<-c()
      
    for(pred_task in pred_task_lst){
      #auxiliary table (for subgroup analysis)
      data_ds<-readRDS(paste0("./data/preproc/",params$site,"/data_ds_",pred_in_d,"d.rda"))
      dat<-readRDS(paste0("./data/preproc/",params$site,"/data_proc.rda"))
      tbl1<-dat$cohort %>%
        dplyr::select(ENCOUNTERID,SERUM_CREAT_BASE, ADMIT_DATE) %>%
        inner_join(dat$demo %>%
                     filter(key=="AGE") %>%
                     dplyr::select(ENCOUNTERID,key,value) %>%
                     spread(key,value) %>%
                     mutate(AGE=as.numeric(AGE)),
                   by="ENCOUNTERID") %>%
        mutate(yr=format(ADMIT_DATE,"%Y"),yr=as.numeric(yr)) %>%
        select(-ADMIT_DATE)
        
        for(fs_type in fs_type_opt){
          #---------------------------------------------------------------------------------------------
          start_i<-Sys.time()
          
          #--load model
          valid_mod<-readRDS(paste0("./data/",model,"_validation/",ref_site,"/",pred_in_d,"d_",fs_type,"_",pred_task,".rda"))
          ref_mod<-valid_mod$model
          tr_key<-data.frame(key = ref_mod$feature_names,
                                 stringsAsFactors = F)
          #--prepare testing set
          X_ts<-data_ds[[pred_task]][[1]]
          y_ts<-data_ds[[pred_task]][[2]]
          
          #--pre-filter
          if(fs_type=="rm_scr_bun"){
            X_ts %<>%
              filter(!(key %in% c(rm_key,paste0(rm_key,"_change"))))
          }
          
          #--transform testing matrix
          y_ts %<>%
            arrange(ENCOUNTERID,dsa_y) %>%
            unite("ROW_ID",c("ENCOUNTERID","dsa_y")) %>%
            arrange(ROW_ID) %>%
            unique
          
          X_ts %<>% 
            unite("ROW_ID",c("ENCOUNTERID","dsa_y")) %>%
            semi_join(y_ts,by="ROW_ID") %>%
            semi_join(tr_key, by="key")
              
          x_add<-tr_key %>%
                anti_join(data.frame(key = unique(X_ts$key),
                                     stringsAsFactors = F),
                          by="key")
            
          y_ts %<>% semi_join(X_ts,by="ROW_ID")
            
          #align with training
          if(nrow(x_add)>0){
            X_ts %<>%
              arrange(ROW_ID) %>%
              bind_rows(data.frame(ROW_ID = rep("0_0",nrow(x_add)),
                                   dsa = -99,
                                   key = x_add$key,
                                   value = 0,
                                   stringsAsFactors=F))
          }
          
          X_ts %<>%
            long_to_sparse_matrix(df=.,
                                  id="ROW_ID",
                                  variable="key",
                                  val="value")
          if(nrow(x_add)>0){
            X_ts<-X_ts[-1,]
          }
          
          X_ts<-X_ts[,tr_key$key]
            
          #check alignment
          if (!all(row.names(X_ts)==y_ts$ROW_ID)){
            warning("row ids don't match!")
          }
          if (!all(tr_key$key==colnames(X_ts))){
            warning("feature names don't match!")
          }
          
          dtest<-xgb.DMatrix(data=X_ts,label=y_ts$y)
          fitted<-predict(ref_mod,X_ts)
          valid_orig<-data.frame(y_ts,
                                 pred = fitted,
                                 stringsAsFactors = F) %>%
            mutate(ENCOUNTERID=gsub("_.*","",ROW_ID),
                   day_at=as.numeric(gsub(".*_","",ROW_ID))) %>%
            inner_join(tbl1,by="ENCOUNTERID") %>%
            dplyr::mutate(age=cut(AGE,breaks=c(0,45,65,Inf),include.lowest=T,right=F)) %>%
            mutate(admit_scr=cut(SERUM_CREAT_BASE,breaks=c(0,1,2,3,Inf),include.lowest=T,right=F))
          
          n<-nrow(valid_orig)
          
          for(b in 1:boots){
            #--bootstrapping
            idxset<-sample(1:n,n,replace=T)
            valid<-valid_orig %>% dplyr::slice(idxset)
            
            #--collect performance metrics
            #full ROC/PRC curve
            perf_full<-get_perf_summ(pred=valid$pred,
                                     real=valid$y,
                                     keep_all_cutoffs=T)$perf_at %>%
              dplyr::select(cutoff,rec_sens,spec,prec) %>%
              mutate(cutoff=round(cutoff,3)) %>%
              group_by(cutoff) %>%
              dplyr::summarise(rec_sens=mean(rec_sens),
                               spec=mean(spec),
                               prec=mean(prec),
                               .groups="drop") %>%
              dplyr::mutate(size=nrow(valid),
                            grp="Overall",
                            pred_task=pred_task)
            
            #overall
            perf_overall<-get_perf_summ(pred=valid$pred,
                                        real=valid$y,
                                        keep_all_cutoffs=F)$perf_summ %>%
              dplyr::filter(overall_meas %in% perf_metrics) %>%
              dplyr::mutate(size=nrow(valid),
                            grp="Overall",
                            pred_task=pred_task)
            
            calib<-get_calibr(pred=valid$pred,
                              real=valid$y) %>%
              mutate(grp="ALL",pred_task=pred_task)
            
            
            #subgroup-by calendar year
            subgrp_calyr_full<-c()
            subgrp_calyr<-c()
            subgrp_calyr_calib<-c()
            for(valid_type in c("int","ext")){
              if(valid_type=="int"){
                valid_grp<-valid %>% filter(yr<=2016)
              }else{
                valid_grp<-valid %>% filter(yr>2016)
              }
              grp_summ<-get_perf_summ(pred=valid_grp$pred,
                                      real=valid_grp$y,
                                      keep_all_cutoffs=F)$perf_summ %>%
                dplyr::filter(overall_meas %in% perf_metrics)
              
              subgrp_calyr_full %<>%
                bind_rows(get_perf_summ(pred=valid_grp$pred,
                                        real=valid_grp$y,
                                        keep_all_cutoffs=T)$perf_at %>%
                            dplyr::select(cutoff,rec_sens,spec,prec) %>%
                            mutate(cutoff=round(cutoff,6)) %>%
                            group_by(cutoff) %>%
                            dplyr::summarise(rec_sens=mean(rec_sens),
                                             spec=mean(spec),
                                             prec=mean(prec),
                                             .groups="drop") %>%
                            dplyr::mutate(grp=paste0("Subgrp_VTYPE:",valid_type),
                                          pred_task=pred_task))
              
              subgrp_calyr %<>% 
                bind_rows(grp_summ %>% 
                            dplyr::mutate(size=nrow(valid_grp),
                                          grp=paste0("Subgrp_VTYPE:",valid_type),
                                          pred_task=pred_task))
              subgrp_calyr_calib %<>%
                bind_rows(get_calibr(pred=valid_grp$pred,
                                     real=valid_grp$y) %>%
                            dplyr::mutate(grp=paste0("Subgrp_VTYPE:",valid_type),
                                          pred_task=pred_task))
            }
            
            
            #subgroup-by day since admission
            subgrp_day_full<-c()
            subgrp_day<-c()
            subgrp_day_calib<-c()
            for(d in 2:7){
              valid_grp<-valid %>% filter(day_at==d)
              grp_summ<-get_perf_summ(pred=valid_grp$pred,
                                      real=valid_grp$y,
                                      keep_all_cutoffs=F)$perf_summ %>%
                dplyr::filter(overall_meas %in% perf_metrics)
              
              subgrp_day_full %<>%
                bind_rows(get_perf_summ(pred=valid_grp$pred,
                                        real=valid_grp$y,
                                        keep_all_cutoffs=T)$perf_at %>%
                            dplyr::select(cutoff,rec_sens,spec,prec) %>%
                            mutate(cutoff=round(cutoff,3)) %>%
                            group_by(cutoff) %>%
                            dplyr::summarise(rec_sens=mean(rec_sens),
                                             spec=mean(spec),
                                             prec=mean(prec),
                                             .groups="drop") %>%
                            dplyr::mutate(grp=paste0("Subgrp_DAY:",d),
                                          pred_task=pred_task))
              
              subgrp_day %<>% 
                bind_rows(grp_summ %>% 
                            dplyr::mutate(size=nrow(valid_grp),
                                          grp=paste0("Subgrp_DAY:",d),
                                          pred_task=pred_task))
              subgrp_day_calib %<>%
                bind_rows(get_calibr(pred=valid_grp$pred,
                                     real=valid_grp$y) %>%
                            dplyr::mutate(grp=paste0("Subgrp_DAY:",d),
                                          pred_task=pred_task))
            }
            
            #subgroup-age
            subgrp_age_full<-c()
            subgrp_age<-c()
            subgrp_age_calib<-c()
            grp_vec<-unique(valid$age)
            for(grp in seq_along(grp_vec)){
              valid_grp<-valid %>% filter(age==grp_vec[grp])
              grp_summ<-get_perf_summ(pred=valid_grp$pred,
                                      real=valid_grp$y,
                                      keep_all_cutoffs=F)$perf_summ %>%
                dplyr::filter(overall_meas %in% perf_metrics)
              
              subgrp_age_full %<>%
                bind_rows(get_perf_summ(pred=valid_grp$pred,
                                        real=valid_grp$y,
                                        keep_all_cutoffs=T)$perf_at %>%
                            dplyr::select(cutoff,rec_sens,spec,prec) %>%
                            mutate(cutoff=round(cutoff,3)) %>%
                            group_by(cutoff) %>%
                            dplyr::summarise(rec_sens=mean(rec_sens),
                                             spec=mean(spec),
                                             prec=mean(prec),
                                             .groups="drop") %>%
                            dplyr::mutate(grp=paste0("Subgrp_AGE:",grp_vec[grp]),
                                          pred_task=pred_task))
              
              subgrp_age %<>% 
                bind_rows(grp_summ %>% 
                            dplyr::mutate(size=nrow(valid_grp),
                                          grp=paste0("Subgrp_AGE:",grp_vec[grp]),
                                          pred_task=pred_task))
              
              subgrp_age_calib %<>%
                bind_rows(get_calibr(pred=valid_grp$pred,
                                     real=valid_grp$y) %>%
                            dplyr::mutate(grp=paste0("Subgrp_AGE:",grp_vec[grp]),
                                          pred_task=pred_task))
            }
            
            #subgroup-scr
            subgrp_scr_full<-c()
            subgrp_scr<-c()
            subgrp_scr_calib<-c()
            grp_vec<-unique(valid$admit_scr)
            for(grp in seq_along(grp_vec)){
              valid_grp<-valid %>% filter(admit_scr==grp_vec[grp])
              grp_summ<-get_perf_summ(pred=valid_grp$pred,
                                      real=valid_grp$y,
                                      keep_all_cutoffs=F)$perf_summ %>%
                filter(overall_meas %in% perf_metrics)
              
              subgrp_scr_full %<>%
                bind_rows(get_perf_summ(pred=valid_grp$pred,
                                        real=valid_grp$y,
                                        keep_all_cutoffs=T)$perf_at %>%
                            dplyr::select(cutoff,rec_sens,spec,prec) %>%
                            mutate(cutoff=round(cutoff,3)) %>%
                            group_by(cutoff) %>%
                            dplyr::summarise(rec_sens=mean(rec_sens),
                                             spec=mean(spec),
                                             prec=mean(prec),
                                             .groups="drop") %>%
                            dplyr::mutate(grp=paste0("Subgrp_Scr_Base:",grp_vec[grp]),
                                          pred_task=pred_task))
              
              subgrp_scr %<>% 
                bind_rows(grp_summ %>% 
                            dplyr::mutate(size=nrow(valid_grp),
                                          grp=paste0("Subgrp_Scr_Base:",grp_vec[grp]),
                                          pred_task=pred_task))
              
              subgrp_scr_calib %<>%
                bind_rows(get_calibr(pred=valid_grp$pred,
                                     real=valid_grp$y) %>%
                            dplyr::mutate(grp=paste0("Subgrp_Scr_Base:",grp_vec[grp]),
                                          pred_task=pred_task))
            }
            
            perf_full %<>%
              bind_rows(subgrp_calyr_full) %>%
              bind_rows(subgrp_day_full) %>%
              bind_rows(subgrp_age_full) %>%
              bind_rows(subgrp_scr_full) %>%
              dplyr::mutate(pred_in_d=pred_in_d,fs_type=fs_type)
            
            perf_full_bs %<>%
              bind_rows(perf_full %>% dplyr::mutate(boots=b))
            
            perf_overall %<>%
              bind_rows(subgrp_calyr) %>%
              bind_rows(subgrp_day) %>%
              bind_rows(subgrp_age) %>%
              bind_rows(subgrp_scr) %>%
              dplyr::mutate(pred_in_d=pred_in_d,fs_type=fs_type) %>%
              dplyr::mutate(meas_val=round(meas_val,4))
            
            perf_overall_bs %<>%
              bind_rows(perf_overall %>% dplyr::mutate(boots=b))
            
            calib %<>%
              bind_rows(subgrp_calyr_calib) %>%
              bind_rows(subgrp_day_calib) %>%
              bind_rows(subgrp_age_calib) %>%
              bind_rows(subgrp_scr_calib) %>%
              dplyr::mutate(pred_in_d=pred_in_d,fs_type=fs_type)
            
            perf_calib_bs %<>%
              bind_rows(calib %>% dplyr::mutate(boots=b))
          }
          
          #---------------------------------------------------------------------------------------------
          lapse<-Sys.time()-start_i
          cat(pred_in_d,",",params$site,",",pred_task,",",fs_type,",","...finished in",lapse,units(lapse),".\n")
         }
      }
}

perf_full_bs %<>%
  gather(meas,meas_val,-pred_in_d,-pred_task,-fs_type,-grp,-size,-boots,-cutoff) %>%
                    group_by(pred_in_d,pred_task,fs_type,grp,size,cutoff,meas) %>%
                    dplyr::summarize(meas_med=median(meas_val,na.rm=T),
                                     meas_lb=quantile(meas_val,probs=0.025,na.rm=T),
                                     meas_ub=quantile(meas_val,probs=0.975,na.rm=T),
                                     .groups="drop")
      
perf_overall_bs %<>%
  group_by(pred_in_d,pred_task,fs_type,grp,overall_meas) %>%
                    dplyr::summarize(size=round(mean(size)),
                                     meas_med=median(meas_val,na.rm=T),
                                     meas_lb=quantile(meas_val,probs=0.025,na.rm=T),
                                     meas_ub=quantile(meas_val,probs=0.975,na.rm=T),
                                     .groups="drop")
      
perf_calib_bs %<>%
  gather(overall_meas,meas_val,-pred_in_d,-pred_task,-fs_type,-pred_bin,-boots,-expos,-grp) %>%
                    group_by(pred_in_d,pred_task,fs_type,pred_bin,overall_meas,grp,expos) %>%
                    dplyr::summarize(meas_med=median(meas_val,na.rm=T),
                                     meas_lb=quantile(meas_val,probs=0.025,na.rm=T),
                                     meas_ub=quantile(meas_val,probs=0.975,na.rm=T),
                                     .groups="drop")
```

Three intermediate files were generated and saved under `data/model_kumc/` folder: 
a) `site_perffull.rda` includes the full ROC and PRC profiles, with all cutoff points as well as all the corresponding sensitivity, specificity and PPV. This file will be used late to construct all AUROC and AUPRC figures;        
b) `site_perfsumm.rda` includes higher level summary of model performance;            
c) `site_calib.rda` includes detailed calibration results. 

***


#### Objective 2.2: Visualization of Validation Results

```{r summ_fig_collector, include=F}
int_valid<-perf_full_bs %>% dplyr::select(-size)

end_pt<-int_valid %>% 
  select(-cutoff,-meas,-meas_med,-meas_lb,-meas_ub) %>%
  unique %>%
  mutate(cutoff=-Inf,
         rec_sens=1,
         spec=0,
         prec=0) %>%
  gather(meas,meas_med,-pred_in_d,-pred_task,-fs_type,-grp,-cutoff) %>%
  mutate(meas_lb=meas_med,
         meas_ub=meas_med)


int_valid %<>%
  bind_rows(end_pt) %>%
  mutate(grp_type=gsub(":.*","",grp),
         grp_cat=gsub(".*:","",grp)) %>%
  filter(!grp_cat %in% c("[3,Inf]") & !grp_cat %in% c(4,6,7) & 
         !(fs_type=="rm_scr_bun"&grp_type!="Subgrp_VTYPE")) %>%
  mutate(grp_type=recode(grp_type,
                         "Subgrp_AGE"="Age",
                         "Subgrp_DAY"="Daily",
                         "Subgrp_Scr_Base"="Baseline Serum Creatinine",
                         "Subgrp_VTYPE"="Validation Type"),
         grp_cat=recode(grp_cat,
                        `1`="1d",
                        `2`="2d",
                        `3`="3d",
                        `5`="4d or more")) %>%
  mutate(grp_cat=case_when(grp_cat=="int"&fs_type=="no_fs" ~ "Int. w/ all features",
                           grp_cat=="int"&fs_type=="rm_scr_bun" ~ "Int. w/o Scr,BUN",
                           grp_cat=="ext"&fs_type=="no_fs" ~ "Tmp.Ext. w/ all features",
                           grp_cat=="ext"&fs_type=="rm_scr_bun" ~ "Tmp.Ext. w/o Scr,BUN",
                           TRUE ~ grp_cat))


#ROC and PRC summaries
int_valid_summ<-perf_overall_bs %>%  dplyr::select(-size) %>%
  dplyr::mutate(label=paste0(round(meas_med+0.005,2),
                             " (",round(meas_lb+0.005,2),",",round(meas_ub+0.005,2),")"))

int_valid_summ %<>%
  mutate(grp_type=gsub(":.*","",grp),
         grp_cat=gsub(".*:","",grp)) %>%
  filter(!grp_cat %in% c("[3,Inf]") & !grp_cat %in% c(4,6,7) & 
           !(fs_type=="rm_scr_bun"&grp_type!="Subgrp_VTYPE")) %>%
  mutate(grp_type=recode(grp_type,
                         "Subgrp_AGE"="Age",
                         "Subgrp_DAY"="Daily",
                         "Subgrp_Scr_Base"="Baseline Serum Creatinine",
                         "Subgrp_VTYPE"="Validation Type"),
         grp_cat=recode(grp_cat,
                        `1`="1d",
                        `2`="2d",
                        `3`="3d",
                        `5`="4d or more")) %>%
  mutate(grp_cat=case_when(grp_cat=="int"&fs_type=="no_fs" ~ "Int. w/ all features",
                           grp_cat=="int"&fs_type=="rm_scr_bun" ~ "Int. w/o Scr,BUN",
                           grp_cat=="ext"&fs_type=="no_fs" ~ "Tmp.Ext. w/ all features",
                           grp_cat=="ext"&fs_type=="rm_scr_bun" ~ "Tmp.Ext. w/o Scr,BUN",
                           TRUE ~ grp_cat))


##---overall ROC&PRC curves
grp_type_sel<-c("Validation Type",
                "Daily",
                "Age",
                "Baseline Serum Creatinine")

int_roc<-list()
int_prc<-list()
int_calib_plot<-list()
for(i in seq_along(pred_task_lst)){
  roc_task<-int_valid %>%
    filter(pred_task==pred_task_lst[i] & 
           meas %in% c("spec") & 
           grp_type != "Overall") %>%
    select(-meas_lb,-meas_ub,-meas) %>%
    dplyr::rename("spec"="meas_med") %>%
    left_join(int_valid %>%
                filter(meas %in% c("rec_sens") & pred_task==pred_task_lst[i] & grp_type != "Overall") %>%
                dplyr::rename("sens"="meas_med") %>% select(-meas),
              by=c("pred_in_d","pred_task","fs_type", "grp","cutoff","grp_type","grp_cat")) %>%
    group_by(pred_in_d,pred_task,fs_type,grp,grp_type,grp_cat) %>%
    arrange(desc(spec),desc(cutoff))  %>%
    dplyr::mutate(sens2=cummax(sens),
                  meas_lb2=cummax(meas_lb),
                  meas_ub2=cummax(meas_ub)) %>%
    ungroup
  
  prc_task<-int_valid %>%
    filter(pred_task==pred_task_lst[i] & 
           meas %in% c("rec_sens") & 
           grp_type != "Overall") %>%
    select(-meas_lb,-meas_ub,-meas) %>%
    dplyr::rename("rec"="meas_med") %>%
    left_join(int_valid %>%
                filter(meas %in% c("prec") & pred_task==pred_task_lst[i] & grp_type != "Overall") %>%
                dplyr::rename("prec"="meas_med") %>% select(-meas),
              by=c("pred_in_d","pred_task","fs_type", "grp","cutoff","grp_type","grp_cat")) %>%
    group_by(pred_in_d,pred_task,fs_type,grp,grp_type,grp_cat) %>%
    arrange(desc(rec),desc(cutoff))  %>%
    dplyr::mutate(prec2=cummax(prec),
                  meas_lb2=cummax(meas_lb),
                  meas_ub2=cummax(meas_ub)) %>%
    ungroup
  
  for(d in c(1,2)){
    
    for(g in seq_along(grp_type_sel)){
      
      roc_sub<-roc_task %>% 
        filter(pred_in_d==d&grp_type==grp_type_sel[g])
      
      prc_sub<-prc_task %>% 
        filter(pred_in_d==d&grp_type==grp_type_sel[g])
      
      annot_sub<-int_valid_summ %>%
        filter(pred_task==pred_task_lst[i]&pred_in_d==d&grp_type==grp_type_sel[g])
      
      int_calib_sub<-int_calib_pvt %>% filter(pred_task==pred_task_lst[i]&pred_in_d==d&grp_type==grp_type_sel[g])
      
      int_calib_hl_sub<-int_calib_hl %>% filter(pred_task==pred_task_lst[i]&pred_in_d==d&grp_type==grp_type_sel[g])
      
      annot_hl<-int_calib_hl_sub %>% 
            mutate(hl_label=paste0(round(chi_sq_adj,2)," (",pmax(round(p_val_adj,3),0.0001),")"))
      
      axis_limits<-c(min(int_calib_sub$y_p,int_calib_sub$pred_p_adj),
                     max(int_calib_sub$y_p,int_calib_sub$pred_p_adj))
      
      int_roc[[paste0(i,d,g)]]<-ggplot(roc_sub,aes(x=(1-spec),y=sens2,color=grp_cat))+
        # geom_smooth(method="gam",formula=y~s(x,bs="cs"))+
        geom_rect(aes(xmin=0,xmax=0.1,ymin=0,ymax=Inf),alpha=0.1,fill="grey80",color="grey80")+
        geom_line()+geom_point()+
        geom_text(data=annot_sub %>% filter(overall_meas=="roauc") %>%
                    arrange(grp_type,desc(grp_cat)) %>%
                    mutate(x=0.6,y=row_number()/10) ,
                         aes(x=x,y=y,color=grp_cat,label=label),
                  fontface="bold",hjust = 0)+
        geom_ribbon(aes(ymin=meas_lb2,ymax=meas_ub2,fill=grp_cat),alpha=0.1)+
        geom_abline(slope=1,intercept=0,linetype=3)+
        scale_x_continuous(limits = c(0,1))+
        guides(color=guide_legend(keyheight=ifelse(g==1|(d==1&g==2),1.2,1.5),
                                  direction="vertical"),
               fill=guide_legend(keyheight=ifelse(g==1|(d==1&g==2),1.2,1.5),
                                 direction="vertical"))+
        theme(text=element_text(size=20,face="bold"))+
        labs(x="",y="", color="",fill="") +
        facet_wrap(~grp_type,scales="free",ncol=4)
      
      int_prc[[paste0(i,d,g)]]<-ggplot(prc_sub,aes(x=rec,y=prec2,color=grp_cat))+
        # geom_smooth(method="gam",formula=y~s(x,bs="cs"))+
        geom_line()+geom_point()+
        geom_text(data=annot_sub %>% filter(overall_meas=="prauc1") %>%
                    arrange(grp_type,grp_cat) %>%
                    mutate(x=0.6,y=1-row_number()/10),
                  aes(x=x,y=y,color=grp_cat,label=label),
                  fontface="bold",hjust = 0)+
        geom_ribbon(aes(ymin=meas_lb2,ymax=meas_ub2,fill=grp_cat),alpha=0.1)+
        scale_x_continuous(limits = c(0,1))+
        guides(color=guide_legend(keyheight=ifelse(g==1|(d==1&g==2),1.2,1.5),
                                  direction="vertical"),
               fill=guide_legend(keyheight=ifelse(g==1|(d==1&g==2),1.2,1.5),
                                  direction="vertical"))+
        theme(text=element_text(size=20,face="bold"))+
        labs(x="",y="",color="",fill="") +
        facet_wrap(~grp_type,scales="free",ncol=4)
      
      int_calib_plot[[paste0(i,d,g)]]<-ggplot(int_calib_sub,aes(y=y_p,x=pred_p_adj,color=grp_cat))+
            geom_smooth(method="lm",size=1.5)+
            # geom_line(size=1.3)+
            geom_point(size=2.5)+
            geom_abline(slope=1,intercept=0,linetype=2)+
            #annotate with HL score
            geom_text(data=annot_hl %>% arrange(grp_type,desc(grp_cat)) %>%
                        mutate(x=qunif(row_number()*2/10,median(int_calib_sub$pred_p),max(int_calib_sub$pred_p)),
                               y=qunif(row_number()*1.5/10,1e-4,max(int_calib_sub$pred_p))),
                      aes(x=x,y=y,color=grp_cat,label=hl_label),
                      fontface="bold",hjust = 0)+
            guides(color=guide_legend(keyheight=ifelse(g==1|(d==1&g==2),1.2,1.5),
                                      direction="horizontal"),
                   fill=guide_legend(keyheight=ifelse(g==1|(d==1&g==2),1.2,1.5),
                                     direction="horizontal"))+
            scale_x_continuous(limits=axis_limits)+
            scale_y_continuous(limits=axis_limits)+
            theme(text=element_text(size=15,face="bold"))+
            labs(x="",y="",color="")+
            facet_wrap(~grp_type,scales="free",ncol=2)
    }
  }
}
```


##### Task I: 48-hour advanced prediction

```{r pred48hr, include=F}
pred_in_d<-1
```

*(I.a) AUROC*

```{r pred48_auroc,echo=F}
fig1<-ggarrange(ggarrange(int_roc[["121"]],int_roc[["221"]],int_roc[["321"]],ncol=1,nrow=3,legend = "bottom",common.legend =T,
                          labels=c("A.Any AKI","B.AKI >= 2","C.AKI 3"),hjust=-0.1,vjust = 1.2,font.label=list(color="red")),
                ggarrange(int_roc[["122"]],int_roc[["222"]],int_roc[["322"]],ncol=1,nrow=3,legend = "bottom",common.legend =T),
                ggarrange(int_roc[["123"]],int_roc[["223"]],int_roc[["323"]],ncol=1,nrow=3,legend = "bottom",common.legend =T),
                ggarrange(int_roc[["124"]],int_roc[["224"]],int_roc[["324"]],ncol=1,nrow=3,legend = "bottom",common.legend =T),
                ncol=4)
annotate_figure(fig1,
                left=text_grob("Sensitivity",rot=90,face="bold",size=20),
                bottom=text_grob("1-Specificity",face="bold",size=20,vjust=-6))
```


*(I.b) AUPRC*

```{r pred24_auprc, echo=F,fig.height = 5, fig.width = 12}
extfig1<-ggarrange(ggarrange(int_prc[["121"]],int_prc[["221"]],int_prc[["321"]],ncol=1,nrow=3,legend = "bottom",common.legend =T,
                             labels=c("A.Any AKI","B.AKI >= 2","C.AKI 3"),hjust=-0.1,vjust = 1.2,font.label=list(color="red")),
                   ggarrange(int_prc[["122"]],int_prc[["222"]],int_prc[["322"]],ncol=1,nrow=3,legend = "bottom",common.legend =T),
                   ggarrange(int_prc[["123"]],int_prc[["223"]],int_prc[["323"]],ncol=1,nrow=3,legend = "bottom",common.legend =T),
                   ggarrange(int_prc[["124"]],int_prc[["224"]],int_prc[["324"]],ncol=1,nrow=3,legend = "bottom",common.legend =T),
                   ncol=4)

annotate_figure(extfig1,
                left=text_grob("Precision",rot=90,face="bold",size=20),
                bottom=text_grob("Recall (Sensitivity)",face="bold",size=20,vjust=-6))
```


***


#### Task II: 24-hour advanced prediction

```{r pred24hr, include=F}
pred_in_d<-2
```

*(II.a) AUROC*

```{r pred24_auroc,echo=F}

```


*(II.b) AUPRC*

```{r pred24_auprc,echo=F, fig.height = 5, fig.width = 12}

```


***

```{r final, include=F}
#--save validation results
saveRDS(perf_full_bs,file=paste0("./data/model_kumc/site_perffull.rda"))
saveRDS(perf_overall_bs,file=paste0("./data/model_kumc/site_perfsumm.rda"))
saveRDS(perf_calib_bs,file=paste0("./data/model_kumc/site_calib.rda"))

# ggplot sometimes create some unwanted empty .pdf file and want to clean it up
if(file.exists("./Rplots.pdf")){
  file.remove("./Rplots.pdf")
}

rm(list=ls())
gc()
```





